<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Applications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .navbar-brand {
      font-weight: bold;
    }
    .badge {
      font-size: 0.9rem;
      padding: 0.35em 0.65em;
    }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="/home.html">Scholarship Manager</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="/home.html">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/scholarship-matches.html">My Matches</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="/my-applications.html">My Applications</a>
        </li>
      </ul>
      <div id="userInfo" class="d-flex align-items-center">
        <span class="navbar-text me-3">Welcome, <span id="navUsername"></span></span>
        <button onclick="logout()" class="btn btn-outline-light">Logout</button>
      </div>
    </div>
  </div>
</nav>

<div class="container py-5">
  <div class="row mb-4">
    <div class="col">
      <h1 class="display-5 fw-bold">My Applications</h1>
      <p class="lead text-muted">
        View the status of your scholarship applications
      </p>
    </div>
  </div>

  <!-- Success/error message alerts -->
  <div id="successAlert" class="alert alert-success d-none"></div>
  <div id="errorAlert" class="alert alert-danger d-none"></div>
  <div id="infoAlert" class="alert alert-info d-none"></div>

  <!-- Message when no applications exist -->
  <div id="noApplicationsAlert" class="alert alert-info d-none">
    You haven't applied for any scholarships yet.
  </div>

  <!-- Applications table -->
  <div id="applicationsTable" class="table-responsive d-none">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
      <tr>
        <th>Scholarship</th>
        <th>Application Date</th>
        <th>Status</th>
        <th>Amount</th>
      </tr>
      </thead>
      <tbody id="applicationsTableBody">
      <!-- Applications will be loaded here -->
      </tbody>
    </table>
  </div>

  <div class="mt-4">
    <a href="/scholarship-matches.html" class="btn btn-primary">
      Back to Recommended Scholarships
    </a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', async function() {
    await loadApplications();
  });

  async function loadApplications() {
    try {
      const response = await fetch('/api/scholarship-matches/my-applications', {
        credentials: 'include'
      });

      if (response.status === 401) {
        window.location.href = '/auth/login.html';
        return;
      }

      if (!response.ok) {
        throw new Error('Failed to load applications');
      }

      const data = await response.json();
      console.log('Applications data:', data);

      // Display student name in navbar
      if (data.student) {
        const displayName = data.student.firstName && data.student.lastName
                ? `${data.student.firstName} ${data.student.lastName}`
                : 'Student';
        document.getElementById('navUsername').textContent = displayName;
      }

      displayApplications(data);
    } catch (error) {
      console.error('Error loading applications:', error);
      showAlert('error', 'Failed to load applications. Please try again later.');
    }
  }

  function displayApplications(data) {
    const applications = data.applications || [];
    const tableBody = document.getElementById('applicationsTableBody');
    const noApplicationsAlert = document.getElementById('noApplicationsAlert');
    const applicationsTable = document.getElementById('applicationsTable');

    // Clear previous content
    tableBody.innerHTML = '';

    if (applications.length === 0) {
      noApplicationsAlert.classList.remove('d-none');
      applicationsTable.classList.add('d-none');
      return;
    }

    noApplicationsAlert.classList.add('d-none');
    applicationsTable.classList.remove('d-none');

    applications.forEach(app => {
      const row = document.createElement('tr');

      // Format application date
      const appDate = app.applicationDate
              ? new Date(app.applicationDate).toLocaleString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })
              : 'N/A';

      // Format amount
      const amount = app.scholarship?.amount
              ? app.scholarship.amount.toLocaleString('en-US', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' RON'
              : 'N/A';

      // Status badge
      let statusBadge;
      switch(app.status) {
        case 'PENDING':
          statusBadge = '<span class="badge bg-warning text-dark">Pending</span>';
          break;
        case 'APPROVED':
          statusBadge = '<span class="badge bg-success">Approved</span>';
          break;
        case 'REJECTED':
          statusBadge = '<span class="badge bg-danger">Rejected</span>';
          break;
        default:
          statusBadge = '<span class="badge bg-secondary">Unknown</span>';
      }

      row.innerHTML = `
                <td>${app.scholarship?.name || 'N/A'}</td>
                <td>${appDate}</td>
                <td>${statusBadge}</td>
                <td>${amount}</td>
            `;

      tableBody.appendChild(row);
    });
  }

  function showAlert(type, message) {
    const alertMap = {
      'success': document.getElementById('successAlert'),
      'error': document.getElementById('errorAlert'),
      'info': document.getElementById('infoAlert')
    };

    // Hide all alerts first
    Object.values(alertMap).forEach(alert => {
      alert.classList.add('d-none');
      alert.textContent = '';
    });

    if (alertMap[type]) {
      alertMap[type].textContent = message;
      alertMap[type].classList.remove('d-none');
    }
  }

  async function logout() {
    try {
      const response = await fetch('/api/auth/logout', {
        method: 'POST',
        credentials: 'include'
      });

      if (response.ok) {
        window.location.href = '/auth/login.html';
      } else {
        console.error('Logout failed');
      }
    } catch (error) {
      console.error('Logout error:', error);
    }
  }
</script>
</body>
</html>